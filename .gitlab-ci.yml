include:
  - project: 'sysadm-docker/ubuntu-sshclient'
    ref:     'master'
    file:    'gitlab-ci-template.yml'

variables:
  SAST_EXPERIMENTAL_FEATURES: "true"

image: $CI_IMAGE

stages:
  - build_doc
  - deploy
  - linking

build doc:
  tags:
    - devops
  stage: build_doc
  only:
    - /^v.*/
  script:
    - ./gradlew dokkaHtmlMultiModule
    - git clone https://$GITHUB_ACCESS_TOKEN@github.com/xsolla/sdk-reference-parser-android.git
    - mkdir -p sdk-reference-parser-android/src/htmlMultiModule
    - mkdir -p sdk-reference-parser-android/dist
    - mv -v build/dokka/htmlMultiModule/* sdk-reference-parser-android/src/htmlMultiModule
    - cd sdk-reference-parser-android
    - sudo apt update
    - sudo apt-get install curl 
    - curl -sL https://deb.nodesource.com/setup_16.x | sudo -E bash - 
    - sudo apt install nodejs 
    - npm install
    - npm start
    - cd dist && zip -r $CI_PROJECT_DIR/build.zip * >/dev/null
  artifacts:
    expire_in: 24 hours
    paths:
      - build.zip

deploy doc:
  stage: deploy
  extends:      .deploy doc
  only:
    - /^v.*/
  dependencies:
    - build doc
  environment:
    name: doc/$CI_COMMIT_REF_SLUG
    url: https://$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME.doc.srv.local/$URL_SLUG
    on_stop: stop doc
  when: manual

current doc:
  extends:      .current doc
  only:
    - /^v.*/
  dependencies:
    - deploy doc
  environment:
    name: doc/current
    url: https://developers.xsolla.com/sdk-code-references/android-store

stop doc:
  extends:      .stop doc
  environment:
    name: doc/$CI_COMMIT_REF_SLUG
    action: stop
  only:
    - /^v.*/
  dependencies: []